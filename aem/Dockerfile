# Note: "Prefer Java JDK 11 for AEM 6.5+"
FROM openjdk:11

ARG PACKAGES_DIR=packages
ARG AEM_DIR=/aem
ARG DEBIAN_FRONTEND=noninteractive
ARG MODE=author
ARG PORT=4502


RUN apt-get update && apt-get install -y maven git \
      && mvn -version \
      && mkdir -p /root/.m2/repository
COPY ./maven/settings.xml /root/.m2
## Check Adobe profile
#RUN mvn help:effective-settings | grep adobe-public

# Create AEM base directory
RUN mkdir -p $AEM_DIR

# Author
COPY ./cq-quickstart-*.jar $AEM_DIR/aem-$MODE-p$PORT.jar
COPY ./license.properties $AEM_DIR
RUN cd $AEM_DIR && java -jar aem-$MODE-p$PORT.jar -unpack

# Copy the packages for startup installation
COPY ./$PACKAGES_DIR $AEM_DIR/crx-quickstart/install/

# Install CIF Components & Venia
# export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64/
#RUN git clone https://github.com/adobe/aem-core-cif-components.git
#RUN git clone https://github.com/adobe/aem-cif-guides-venia.git \
#  && cd aem-cif-guides-venia \
#  && mvn clean install \
#  && cp all/target/*.zip $AEM_DIR/crx-quickstart/install/

# Start AEM and install packages
RUN chmod +x $AEM_DIR/crx-quickstart/bin/start $AEM_DIR/crx-quickstart/bin/stop \
        && $AEM_DIR/crx-quickstart/bin/start \
        && sleep 1m \
        && (timeout 10m tail -f $AEM_DIR/crx-quickstart/logs/error.log; exit 0) \
        && $AEM_DIR/crx-quickstart/bin/stop \
        && sleep 1m

# Run AEM
EXPOSE 4502
CMD ["sh","-c","/aem/crx-quickstart/bin/start && tail -f /aem/crx-quickstart/logs/error.log"]
